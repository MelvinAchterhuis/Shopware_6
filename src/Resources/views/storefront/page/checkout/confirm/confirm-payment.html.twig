{% sw_extends '@Storefront/storefront/page/checkout/confirm/confirm-payment.html.twig' %}

{% block page_checkout_confirm_payment_current_image %}

    {% if context.paymentMethod.translated.customFields.buckaroo_key == 'creditcard' %}
        <img src="{{ page.extensions.buckaroo.media_path }}{{ page.extensions.buckaroo.payment_media }}" class="payment-method-image">
    {% elseif context.paymentMethod.media %}
        {% sw_thumbnails 'confirm-payment-current-image-thumbnails' with {
            media: context.paymentMethod.media,
            sizes: {
                'default': '100px'
            },
            attributes: {
                'class': 'payment-method-image',
                'alt': (context.paymentMethod.media.translated.alt ?: context.paymentMethod.translated.name),
                'title': (context.paymentMethod.media.translated.title ?: context.paymentMethod.translated.name)
            }
        } %}
    {% endif %}

{% endblock %}

{% block page_checkout_confirm_payment_current_text %}

    {% if context.paymentMethod.translated.customFields.buckaroo_key == 'ideal' or context.paymentMethod.translated.customFields.buckaroo_key == 'idealprocessing' %}
    <strong>{{ "checkout.confirmCurrentPaymentShipping"|trans }}</strong>
        
        {{ page.extensions.buckaroo.payment_labels[context.paymentMethod.translated.customFields.buckaroo_key]?:context.paymentMethod.translated.name }}

        {% if page.extensions.buckaroo.issuers|length > 0 %}
            <div>
                <label><strong>{{ "buckaroo.checkout.selectBankIssuer"|trans|sw_sanitize }}</strong>*:</label>
                {% for issuer in page.extensions.buckaroo.issuers %}
                    <div class="custom-control custom-radio bank-control">
                        <input type="radio"
                        form="confirmOrderForm"
                        required="required"
                        id="bankMethod{{ issuer.code }}"
                        name="bankMethodId"
                        value="{{ issuer.code }}"
                        class="custom-control-input bank-method-input">
                        <label class="custom-control-label bank-method-label" for="bankMethod{{ issuer.code }}">
                            <img src="{{ page.extensions.buckaroo.media_path }}{{ issuer.code }}.png" class="bank-method-image" width=20  alt="{{ issuer.name }}" title="{{ issuer.name }}">
                            <strong>{{ issuer.name }}</strong>
                        </label>
                    </div>
                {% endfor %}
            </div>
        {% endif %}

    {% elseif context.paymentMethod.translated.customFields.buckaroo_key == 'creditcard' %}
        <strong>{{ "checkout.confirmCurrentPaymentShipping"|trans }}</strong>
        {{ page.extensions.buckaroo.payment_method_name_card }}

    {% elseif context.paymentMethod.translated.customFields.buckaroo_key == 'creditcards' %}

        <strong>{{ "checkout.confirmCurrentPaymentShipping"|trans }}</strong>
        
        {{ page.extensions.buckaroo.payment_labels[context.paymentMethod.translated.customFields.buckaroo_key]?:context.paymentMethod.translated.name }}

        {% if page.extensions.buckaroo.creditcards|length > 0 %}

            <div class="card styled">
                <div class="fieldset card_front width-100">
                    <div class="card_kind">
                        <img id="card_kind_img" src="/bundles/buckaroopayment/storefront/buckaroo/logo/creditcards.png">
                    </div>
                    <div class="field required width-70">
                        <label class="label" for="creditcards_issuer">
                            <span>{{ "buckaroo.checkout.creditcards.card"|trans }}:</span>
                        </label>
                        <select name="creditcards_issuer" id="creditcards_issuer" form="confirmOrderForm" required="required" class="creditcards_input">
                            <option value="" data-logo="/bundles/buckaroopayment/storefront/buckaroo/logo/creditcards.png">{{ "buckaroo.checkout.selectCreditCard"|trans }}</option>
                                {% for creditcard in page.extensions.buckaroo.creditcards %}
                                    <option data-logo="/bundles/buckaroopayment/storefront/buckaroo/logo/{{ creditcard.code }}.png" value="{{ creditcard.code }}">{{ creditcard.name }}</option>
                                {% endfor %}
                        </select>   
                    </div>

                <div class="field required width-100">
                    <label class="label" for="creditcards_cardholdername"><span>{{ "buckaroo.checkout.creditcards.cardholder"|trans }}:</span></label>
                    <input type="text" id="creditcards_cardholdername" name="creditcards_cardholdername" form="confirmOrderForm" required="required" class="creditcards_input">
                    <input type="hidden" id="encryptedCardData" name="encryptedCardData" form="confirmOrderForm">
                </div>

                <div class="field required width-100">
                    <label class="label" for="creditcards_cardnumber"><span>{{ "buckaroo.checkout.creditcards.cardNumber"|trans }}:</span></label>
                    <input type="text" id="creditcards_cardnumber" name="creditcards_cardnumber" form="confirmOrderForm" required="required" class="creditcards_input">
                </div>

                <div class="field required width-50-l">
                    <label class="label" for="creditcards_expirationmonth"><span>{{ "buckaroo.checkout.creditcards.month"|trans }}:</span></label>
                    <select type="text" id="creditcards_expirationmonth" name="creditcards_expirationmonth" form="confirmOrderForm" required="required" class="creditcards_input">
                        <option value="">{{ "buckaroo.checkout.creditcards.selectMonth"|trans }}</option>
                        <option value="1">1</option> <option value="2">2</option> <option value="3">3</option> <option value="4">4</option> <option value="5">5</option> <option value="6">6</option> <option value="7">7</option> <option value="8">8</option> <option value="9">9</option> <option value="10">10</option> <option value="11">11</option> <option value="12">12</option>
                    </select>
                </div>

                <div class="field required width-50-r">
                    <label class="label" for="creditcards_expirationyear"><span>{{ "buckaroo.checkout.creditcards.year"|trans }}:</span></label>
                    <select type="text" id="creditcards_expirationyear" name="creditcards_expirationyear" form="confirmOrderForm" required="required" class="creditcards_input">
                        <option value="">{{ "buckaroo.checkout.creditcards.selectYear"|trans }}</option>
                        <option value="2020">2020</option> <option value="2021">2021</option> <option value="2022">2022</option> <option value="2023">2023</option> <option value="2024">2024</option> <option value="2025">2025</option> <option value="2026">2026</option> <option value="2027">2027</option> <option value="2028">2028</option> <option value="2029">2029</option> <option value="2030">2030</option>
                    </select>
                </div>

                </div>

                <div class="fieldset card_back width-100">
                    <div class="magnet_stripe width-100"></div>
                    <div class="field required card_security width-100">
                        <label class="label width-65-l" for="creditcards_cvc">
                            <span>{{ "buckaroo.checkout.creditcards.securityCode"|trans }}:</span></label>
                        <div class="control card-info-input width-25-l">
                            <input type="text" id="creditcards_cvc" name="creditcards_cvc" form="confirmOrderForm" required="required" class="creditcards_input">
                        </div>
                        <div class="card_info width-10"></div>
                    </div>
                </div>

            </div>

        {% endif %}

    {% elseif context.paymentMethod.translated.customFields.buckaroo_key == 'afterpay' %}
        <strong>{{ "checkout.confirmCurrentPaymentShipping"|trans }}</strong>
        
        {{ page.extensions.buckaroo.payment_labels[context.paymentMethod.translated.customFields.buckaroo_key]?:context.paymentMethod.translated.name }}

    <div class="payment-method-second-col billing-address-form">
        <fieldset class="fieldset payment">

            <div class="form-group">
                <label class="form-label" for="buckarooAfterpayPhone">
                    {{ "buckaroo.checkout.buckarooAfterpayPhone"|trans|sw_sanitize }}{{ "general.required"|trans|sw_sanitize }}
                </label>

                <input type="text"
                       class="form-control{% if formViolations.getViolations('/title') %} is-invalid{% endif %}"
                       form="confirmOrderForm"
                       id="buckarooAfterpayPhone"
                       name="buckaroo_afterpay_phone"
                       placeholder="{{ "buckaroo.checkout.buckarooAfterpayPhonePlaceholder"|trans|striptags }}{{ "general.required"|trans|striptags }}"
                       value=""
                       required="required"
                       minlength="10">
            </div>

            <div class="form-group">
                <label class="label" for="buckaroo_afterpay_DoB">{{ "buckaroo.checkout.buckarooAfterpayDoBTitle"|trans }}:</label>
                <span><sup>{{ "buckaroo.checkout.buckarooAfterpayDoBTitleSup"|trans }}</sup></span>
                <div class="control">
                    <input id="buckaroo_afterpay_DoB" 
                    class="form-control field" 
                    type="date"
                    max='{{ "now"|date_modify("-18 years")|date("Y-m-d") }}'
                    name="buckaroo_afterpay_DoB"
                    form="confirmOrderForm"
                    required="required"
                    >
                </div>
            </div>

            <div class="custom-control custom-checkbox">
                <input id="buckaroo_afterpay_TermsCondition" class="custom-control-input" form="confirmOrderForm" name="buckaroo_afterpay_TermsCondition" required="required" type="checkbox">
                <label class="custom-control-label" for="buckaroo_afterpay_TermsCondition"> <span>{{ "buckaroo.checkout.buckarooAfterpayTermsConditionTitle"|trans }}:</span> </label>
                <span>
                    <a target="_blank" href="https://documents.myafterpay.com/consumer-terms-conditions/nl_nl/">{{ "buckaroo.checkout.buckarooAfterpayTermsCondition"|trans }}</a>
                </span>
            </div>

        </fieldset>
    </div>

    {% elseif context.paymentMethod.translated.customFields.buckaroo_key == 'giropay' %}
        <strong>{{ "checkout.confirmCurrentPaymentShipping"|trans }}</strong>
        
        {{ page.extensions.buckaroo.payment_labels[context.paymentMethod.translated.customFields.buckaroo_key]?:context.paymentMethod.translated.name }}

    <div class="payment-method-second-col billing-address-form">
        <fieldset class="fieldset payment">

            <div class="form-group">
                <label class="form-label" for="buckarooGiropayBic">
                    {{ "buckaroo.checkout.buckarooGiropayBic"|trans|sw_sanitize }}{{ "general.required"|trans|sw_sanitize }}
                </label>

                <input type="text"
                       class="form-control"
                       form="confirmOrderForm"
                       id="buckarooGiropayBic"
                       name="buckarooGiropayBic"
                       pattern="([a-zA-Z]{4})([a-zA-Z]{2})(([2-9a-zA-Z]{1})([0-9a-np-zA-NP-Z]{1}))((([0-9a-wy-zA-WY-Z]{1})([0-9a-zA-Z]{2}))|([xX]{3})|)"
                       placeholder="{{ "buckaroo.checkout.buckarooGiropayBicPlaceholder"|trans|striptags }}{{ "general.required"|trans|striptags }}"
                       required="required">
            </div>
        </fieldset>
    </div>

    {% elseif context.paymentMethod.translated.customFields.buckaroo_key == 'sepadirectdebit' %}
        <strong>{{ "checkout.confirmCurrentPaymentShipping"|trans }}</strong>
        
        {{ page.extensions.buckaroo.payment_labels[context.paymentMethod.translated.customFields.buckaroo_key]?:context.paymentMethod.translated.name }}

            <div class="payment-method-second-col billing-address-form">
                <fieldset class="fieldset payment">

                <div class="form-group">
                    <label class="form-label" for="buckarooSepaDirectDebitCustomer">
                        {{ "buckaroo.checkout.buckarooSepaDirectDebitCustomer"|trans|sw_sanitize }}{{ "general.required"|trans|sw_sanitize }}
                    </label>

                    <input type="text"
                           class="form-control"
                           form="confirmOrderForm"
                           id="buckarooSepaDirectDebitCustomer"
                           name="buckarooSepaDirectDebitCustomer"
                           placeholder="{{ "buckaroo.checkout.buckarooSepaDirectDebitCustomerholder"|trans|striptags }}{{ "general.required"|trans|striptags }}"
                           required="required"
                           minlength="2">
                </div>

                <div class="form-group">
                    <label class="form-label" for="buckarooSepaDirectDebitIBAN">
                        {{ "buckaroo.checkout.buckarooIBAN"|trans|sw_sanitize }}{{ "general.required"|trans|sw_sanitize }}
                    </label>

                    <input type="text"
                           class="form-control"
                           form="confirmOrderForm"
                           id="buckarooSepaDirectDebitIBAN"
                           name="buckarooSepaDirectDebitIBAN"
                           pattern="^([A-Z]{2}[ \-]?[0-9]{2})(?=(?:[ \-]?[A-Z0-9]){9,30}$)((?:[ \-]?[A-Z0-9]{3,5}){2,7})([ \-]?[A-Z0-9]{1,3})?$"
                           placeholder="{{ "buckaroo.checkout.buckarooIBANPlaceholder"|trans|striptags }}{{ "general.required"|trans|striptags }}"
                           required="required">
                </div>
            </fieldset>
        </div>

    {% else %}
        <strong>{{ "checkout.confirmCurrentPaymentShipping"|trans|sw_sanitize }}</strong>
        {{ page.extensions.buckaroo.payment_labels[context.paymentMethod.translated.customFields.buckaroo_key]?:context.paymentMethod.translated.name }}
    {% endif %}
    
{% endblock %}

{% block page_checkout_confirm_payment_inner %}
    {{ parent() }}
    {% if context.paymentMethod.formattedHandlerIdentifier == 'handler_buckaroo_applepaypaymenthandler' %}
        <div id="applepay-button-container" class="applepay-button-container" style="display:none;">
            <div></div>
        </div>
        <input type="hidden"
               form="confirmOrderForm"
               id="applePayInfo"
               name="applePayInfo"
               value="">
        <script>
            if (!window.buckaroo) {
                window.buckaroo = {
                    submit: false,
                    csrf: {
                        '/Buckaroo/applepayInit': '{{ sw_csrf("frontend.buckaroo.applepayInit", {"mode": "token"}) }}',
                        '/Buckaroo/applepaySaveOrder': '{{ sw_csrf("frontend.buckaroo.applepaySaveOrder", {"mode": "token"}) }}'
                    }
                };
            }
            setTimeout(function() {
                if (document.getElementById('confirmFormSubmit')) {
                    document.getElementById('confirmFormSubmit').disabled = true;
                    document.getElementById('confirmFormSubmit').addEventListener('click', function(e){
                        e.stopPropagation();
                    });
                    document.getElementById('confirmOrderForm').addEventListener('submit', function(e){
                        if (window.buckaroo.submit) {
                            //allow to submit
                            return true;
                        } else {
                            //don't allow to submit
                            e.preventDefault();
                            var child = document.querySelector('.apple-pay-button');
                            if (child) {
                                //ZAK
                                console.log("====applepay====order submit3");
                                child.click();
                            }
                        }
                    });
                }
            }, 200)
        </script>
        <script type="module" src="/bundles/buckaroopayment/storefront/buckaroo/js/applepay/index.js"></script>
    {% endif %}
{% endblock %}
