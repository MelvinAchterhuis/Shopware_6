{% sw_extends '@Storefront/storefront/page/checkout/confirm/confirm-payment.html.twig' %}

{% block page_checkout_confirm_payment_current_image %}

    {% if context.paymentMethod.translated.customFields.buckaroo_key == 'creditcard' %}
        <img src="{{ page.extensions.buckaroo.media_path }}{{ page.extensions.buckaroo.payment_media }}" class="payment-method-image">
    {% elseif context.paymentMethod.media %}
        {% sw_thumbnails 'confirm-payment-current-image-thumbnails' with {
            media: context.paymentMethod.media,
            sizes: {
                'default': '100px'
            },
            attributes: {
                'class': 'payment-method-image',
                'alt': (context.paymentMethod.media.translated.alt ?: context.paymentMethod.translated.name),
                'title': (context.paymentMethod.media.translated.title ?: context.paymentMethod.translated.name)
            }
        } %}
    {% endif %}

{% endblock %}

{% block page_checkout_confirm_payment_current_text %}

    {% if context.paymentMethod.translated.customFields.buckaroo_key == 'ideal' or context.paymentMethod.translated.customFields.buckaroo_key == 'idealprocessing' %}
    <strong>{{ "checkout.confirmCurrentPaymentShipping"|trans }}</strong>
        
        {{ page.extensions.buckaroo.payment_labels[context.paymentMethod.translated.customFields.buckaroo_key]?:context.paymentMethod.translated.name }}

        {% if page.extensions.buckaroo.issuers|length > 0 %}
            <div>
                <label><strong>{{ "buckaroo.checkout.selectBankIssuer"|trans|sw_sanitize }}</strong>*:</label>
                {% for issuer in page.extensions.buckaroo.issuers %}
                    <div class="custom-control custom-radio bank-control">
                        <input type="radio"
                        form="confirmOrderForm"
                        required="required"
                        id="bankMethod{{ issuer.code }}"
                        name="bankMethodId"
                        value="{{ issuer.code }}"
                        class="custom-control-input bank-method-input">
                        <label class="custom-control-label bank-method-label" for="bankMethod{{ issuer.code }}">
                            <img src="{{ page.extensions.buckaroo.media_path }}{{ issuer.code }}.png" class="bank-method-image" width=20  alt="{{ issuer.name }}" title="{{ issuer.name }}">
                            <strong>{{ issuer.name }}</strong>
                        </label>
                    </div>
                {% endfor %}
            </div>
        {% endif %}

    {% elseif context.paymentMethod.translated.customFields.buckaroo_key == 'creditcard' %}
        <strong>{{ "checkout.confirmCurrentPaymentShipping"|trans }}</strong>
        {{ page.extensions.buckaroo.payment_method_name_card }}

    {% elseif context.paymentMethod.translated.customFields.buckaroo_key == 'creditcards' %}

        <strong>{{ "checkout.confirmCurrentPaymentShipping"|trans }}</strong>
        
        {{ page.extensions.buckaroo.payment_labels[context.paymentMethod.translated.customFields.buckaroo_key]?:context.paymentMethod.translated.name }}

        {% if page.extensions.buckaroo.creditcards|length > 0 %}

        <div class="card buckaroo-creditcards">
            <fieldset>
                <div class="form-row col-md-12">
                    <div class="form-group col-md-12">
                        <label class="form-label" for="creditcards_issuer">{{ "buckaroo.checkout.creditcards.card" | trans }}:</label>
                        <select name="creditcards_issuer" id="creditcards_issuer" form="confirmOrderForm" required="required" class="form-control">
                            <option value="" data-logo="/bundles/buckaroopayment/storefront/buckaroo/logo/creditcards.png">{{ "buckaroo.checkout.selectCreditCard"|trans }}</option>
                                {% for creditcard in page.extensions.buckaroo.creditcards %}
                                    <option data-logo="/bundles/buckaroopayment/storefront/buckaroo/logo/{{ creditcard.code }}.png" value="{{ creditcard.code }}">{{ creditcard.name }}</option>
                                {% endfor %}
                        </select>  
                        <div class="card_kind">
                            <img id="card_kind_img" src="/bundles/buckaroopayment/storefront/buckaroo/logo/creditcards.png">
                        </div>
                    </div>

                    <div class="form-group col-md-12">
                        <label class="form-label" for="creditcards_cardholdername">{{ "buckaroo.checkout.creditcards.cardholder" | trans }}:</label>
                        <input class="form-control" id="creditcards_cardholdername" name="creditcards_cardholdername" form="confirmOrderForm" required="required" />
                        <input type="hidden" id="encryptedCardData" name="encryptedCardData" form="confirmOrderForm">
                    </div>

                    <div class="form-group col-md-12">
                        <label class="form-label" for="creditcards_cardnumber">{{ "buckaroo.checkout.creditcards.cardNumber" | trans }}:</label>
                        <input class="form-control" id="creditcards_cardnumber" name="creditcards_cardnumber" form="confirmOrderForm" required="required" />
                    </div>

                    <div class="form-group col-md-6">
                        <label class="form-label" for="creditcards_expirationmonth">{{ "buckaroo.checkout.creditcards.month" | trans }}:</label>
                        <select type="text" id="creditcards_expirationmonth" name="creditcards_expirationmonth" form="confirmOrderForm" required="required" class="form-control">
                            <option value="">{{ "buckaroo.checkout.creditcards.selectMonth"|trans }}</option>
                            {% for month in 1..12 %}
                                <option value="{{ month }}">{{ month }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group col-md-6">
                        <label class="form-label" for="creditcards_expirationyear">{{ "buckaroo.checkout.creditcards.year" | trans }}:</label>
                        <select type="text" id="creditcards_expirationyear" name="creditcards_expirationyear" form="confirmOrderForm" required="required" class="form-control">
                            <option value="">{{ "buckaroo.checkout.creditcards.selectYear"|trans }}</option>
                            {% set start_year = date() | date('Y') %}
                            {% set end_year = start_year + 10 %}

                            {% for year in start_year..end_year %}
                                <option value="{{ year }}">{{ year }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group col-md-6">
                        <label class="form-label" for="creditcards_cvc">{{ "buckaroo.checkout.creditcards.securityCode" | trans }}:</label>
                        <input class="form-control" id="creditcards_cvc" name="creditcards_cvc" form="confirmOrderForm" required="required" />
                    </div>

                </div>
            </fieldset>
        </div>

        {% endif %}

    {% elseif context.paymentMethod.translated.customFields.buckaroo_key == 'afterpay' %}
        <strong>{{ "checkout.confirmCurrentPaymentShipping"|trans }}</strong>
        
        {{ page.extensions.buckaroo.payment_labels[context.paymentMethod.translated.customFields.buckaroo_key]?:context.paymentMethod.translated.name }}

    <div class="payment-method-second-col billing-address-form">
        <fieldset class="fieldset payment">

            <div class="form-group">
                <label class="form-label" for="buckarooAfterpayPhone">
                    {{ "buckaroo.checkout.buckarooAfterpayPhone"|trans|sw_sanitize }}{{ "general.required"|trans|sw_sanitize }}
                </label>

                <input type="text"
                       class="form-control{% if formViolations.getViolations('/title') %} is-invalid{% endif %}"
                       form="confirmOrderForm"
                       id="buckarooAfterpayPhone"
                       name="buckaroo_afterpay_phone"
                       placeholder="{{ "buckaroo.checkout.buckarooAfterpayPhonePlaceholder"|trans|striptags }}{{ "general.required"|trans|striptags }}"
                       value=""
                       required="required"
                       minlength="10">

                <label class="form-label" style="display:none; color:red" for="buckarooAfterpayPhone" id="buckarooMobilePhoneError">
                    {{ "buckaroo.checkout.buckarooMobilePhoneError"|trans|sw_sanitize }}
                </label>
            </div>

            <div class="form-group">
                <label class="label" for="buckaroo_afterpay_DoB">{{ "buckaroo.checkout.buckarooAfterpayDoBTitle"|trans }}:</label>
                <span><sup>{{ "buckaroo.checkout.buckarooAfterpayDoBTitleSup"|trans }}</sup></span>
                <div class="control">
                    <input id="buckaroo_afterpay_DoB" 
                    class="form-control field" 
                    type="date"
                    max='{{ "now"|date_modify("-18 years")|date("Y-m-d") }}'
                    name="buckaroo_afterpay_DoB"
                    form="confirmOrderForm"
                    required="required"
                    >

                    <label class="form-label" style="display:none; color:red" for="buckaroo_afterpay_DoB" id="buckarooDoBPhoneError">
                        {{ "buckaroo.checkout.buckarooDoBError"|trans|sw_sanitize }}
                    </label>
                </div>
            </div>

            <div class="custom-control custom-checkbox">
                <input id="buckaroo_afterpay_TermsCondition" class="custom-control-input" form="confirmOrderForm" name="buckaroo_afterpay_TermsCondition" required="required" type="checkbox">
                <label class="custom-control-label" for="buckaroo_afterpay_TermsCondition"> <span>{{ "buckaroo.checkout.buckarooAfterpayTermsConditionTitle"|trans }}:</span> </label>
                <span>
                    <a target="_blank" href="https://documents.myafterpay.com/consumer-terms-conditions/nl_nl/">{{ "buckaroo.checkout.buckarooAfterpayTermsCondition"|trans }}</a>
                </span>
            </div>

        </fieldset>
    </div>
    
    {% elseif context.paymentMethod.translated.customFields.buckaroo_key == 'capayable' %}
        <strong>{{ "checkout.confirmCurrentPaymentShipping"|trans }}</strong>
        
        {{ page.extensions.buckaroo.payment_labels[context.paymentMethod.translated.customFields.buckaroo_key]?:context.paymentMethod.translated.name }}

        <div class="payment-method-second-col billing-address-form">
            <fieldset class="fieldset payment">

                <div class="form-group">
                    <label class="form-label" for="buckarooIn3Phone">
                        {{ "buckaroo.checkout.buckarooAfterpayPhone"|trans|sw_sanitize }}{{ "general.required"|trans|sw_sanitize }}
                    </label>

                    <input type="text"
                           class="form-control{% if formViolations.getViolations('/title') %} is-invalid{% endif %}"
                           form="confirmOrderForm"
                           id="buckarooIn3Phone"
                           name="buckaroo_in3_phone"
                           placeholder="{{ "buckaroo.checkout.buckarooAfterpayPhonePlaceholder"|trans|striptags }}{{ "general.required"|trans|striptags }}"
                           value=""
                           required="required"
                           minlength="10">

                    <label class="form-label" style="display:none; color:red" for="buckarooIn3Phone" id="buckarooMobilePhoneError">
                        {{ "buckaroo.checkout.buckarooMobilePhoneError"|trans|sw_sanitize }}
                    </label>
                </div>

                <div class="form-group">
                    <label class="label" for="buckaroo_capayablein3_DoB">{{ "buckaroo.checkout.buckarooAfterpayDoBTitle"|trans }}:</label>
                    <span><sup>{{ "buckaroo.checkout.buckarooAfterpayDoBTitleSup"|trans }}</sup></span>
                    <div class="control">
                        <input id="buckaroo_capayablein3_DoB" 
                        class="form-control field" 
                        type="date"
                        max='{{ "now"|date_modify("-18 years")|date("Y-m-d") }}'
                        name="buckaroo_capayablein3_DoB"
                        form="confirmOrderForm"
                        required="required"
                        >
                    <label class="form-label" style="display:none; color:red" for="buckaroo_capayablein3_DoB" id="buckarooDoBPhoneError">
                        {{ "buckaroo.checkout.buckarooDoBError"|trans|sw_sanitize }}
                    </label>
                    </div>
                </div>

                <div class="field">
                    <label class="label" for="buckaroo_capayablein3_OrderAs"> <span>{{ "buckaroo.checkout.orderAs"|trans }}:</span> </label>
                    <div class="control">
                        <select id="buckaroo_capayablein3_OrderAs" name="buckaroo_capayablein3_orderAs" form="confirmOrderForm">
                            <option value="Debtor">{{ "buckaroo.checkout.private"|trans }}</option>
                            <option value="Company">{{ "buckaroo.checkout.company"|trans }}</option>
                            <option value="SoleProprietor">{{ "buckaroo.checkout.oneManBusiness"|trans }}</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" id='buckaroo_capayablein3_COCNumberDiv'>
                    <label class="label" for="buckaroo_capayablein3_COCNumber">{{ "buckaroo.checkout.cOCNumber"|trans }}:</label>
                    <div class="control">
                        <input id="buckaroo_capayablein3_COCNumber" 
                        class="form-control field" 
                        type="text"
                        name="buckaroo_capayablein3_COCNumber"
                        form="confirmOrderForm"
                        minlength="8"
                        required="required"
                        >
                    </div>
                </div>

                <div class="form-group" id='buckaroo_capayablein3_CompanyNameDiv'>
                    <label class="label" for="buckaroo_capayablein3_CompanyName">{{ "buckaroo.checkout.companyName"|trans }}:</label>
                    <div class="control">
                        <input id="buckaroo_capayablein3_CompanyName" 
                        class="form-control field" 
                        type="text"
                        name="buckaroo_capayablein3_CompanyName"
                        form="confirmOrderForm"
                        required="required"
                        >
                    </div>
                </div>

            </fieldset>
        </div>

    {% elseif context.paymentMethod.translated.customFields.buckaroo_key == 'giropay' %}
        <strong>{{ "checkout.confirmCurrentPaymentShipping"|trans }}</strong>
        
        {{ page.extensions.buckaroo.payment_labels[context.paymentMethod.translated.customFields.buckaroo_key]?:context.paymentMethod.translated.name }}

    <div class="payment-method-second-col billing-address-form">
        <fieldset class="fieldset payment">

            <div class="form-group">
                <label class="form-label" for="buckarooGiropayBic">
                    {{ "buckaroo.checkout.buckarooGiropayBic"|trans|sw_sanitize }}{{ "general.required"|trans|sw_sanitize }}
                </label>

                <input type="text"
                       class="form-control"
                       form="confirmOrderForm"
                       id="buckarooGiropayBic"
                       name="buckarooGiropayBic"
                       pattern="([a-zA-Z]{4})([a-zA-Z]{2})(([2-9a-zA-Z]{1})([0-9a-np-zA-NP-Z]{1}))((([0-9a-wy-zA-WY-Z]{1})([0-9a-zA-Z]{2}))|([xX]{3})|)"
                       placeholder="{{ "buckaroo.checkout.buckarooGiropayBicPlaceholder"|trans|striptags }}{{ "general.required"|trans|striptags }}"
                       required="required">
            </div>
        </fieldset>
    </div>

    {% elseif context.paymentMethod.translated.customFields.buckaroo_key == 'sepadirectdebit' %}
        <strong>{{ "checkout.confirmCurrentPaymentShipping"|trans }}</strong>
        
        {{ page.extensions.buckaroo.payment_labels[context.paymentMethod.translated.customFields.buckaroo_key]?:context.paymentMethod.translated.name }}

            <div class="payment-method-second-col billing-address-form">
                <fieldset class="fieldset payment">

                <div class="form-group">
                    <label class="form-label" for="buckarooSepaDirectDebitCustomer">
                        {{ "buckaroo.checkout.buckarooSepaDirectDebitCustomer"|trans|sw_sanitize }}{{ "general.required"|trans|sw_sanitize }}
                    </label>

                    <input type="text"
                           class="form-control"
                           form="confirmOrderForm"
                           id="buckarooSepaDirectDebitCustomer"
                           name="buckarooSepaDirectDebitCustomer"
                           placeholder="{{ "buckaroo.checkout.buckarooSepaDirectDebitCustomerholder"|trans|striptags }}{{ "general.required"|trans|striptags }}"
                           required="required"
                           minlength="2">
                </div>

                <div class="form-group">
                    <label class="form-label" for="buckarooSepaDirectDebitIBAN">
                        {{ "buckaroo.checkout.buckarooIBAN"|trans|sw_sanitize }}{{ "general.required"|trans|sw_sanitize }}
                    </label>

                    <input type="text"
                           class="form-control"
                           form="confirmOrderForm"
                           id="buckarooSepaDirectDebitIBAN"
                           name="buckarooSepaDirectDebitIBAN"
                           pattern="^([A-Z]{2}[ \-]?[0-9]{2})(?=(?:[ \-]?[A-Z0-9]){9,30}$)((?:[ \-]?[A-Z0-9]{3,5}){2,7})([ \-]?[A-Z0-9]{1,3})?$"
                           placeholder="{{ "buckaroo.checkout.buckarooIBANPlaceholder"|trans|striptags }}{{ "general.required"|trans|striptags }}"
                           required="required">
                </div>
            </fieldset>
        </div>

    {% elseif context.paymentMethod.translated.customFields.buckaroo_key == 'Przelewy24' %}
        <strong>{{ "checkout.confirmCurrentPaymentShipping"|trans|sw_sanitize }}</strong>
        {{ page.extensions.buckaroo.payment_labels[context.paymentMethod.translated.customFields.buckaroo_key]?:context.paymentMethod.translated.name }}

        <input type="hidden"
                           value="{{ page.extensions.buckaroo.currency }}"
                           class="form-control"
                           form="confirmOrderForm"
                           id="P24Currency"
                           name="P24Currency">
        <div id="P24CurrencyError">To process the payment with Przelewy24 the currency must be set to polish Zloty</div>

    {% elseif context.paymentMethod.translated.customFields.buckaroo_key == 'klarnakp' %}
        <strong>{{ "checkout.confirmCurrentPaymentShipping"|trans }}</strong>

        {{ page.extensions.buckaroo.payment_labels[context.paymentMethod.translated.customFields.buckaroo_key]?:context.paymentMethod.translated.name }}

        <div class="payment-method-second-col billing-address-form">
            <fieldset class="fieldset payment">

                <div class="form-group">
                    <label class="form-label" for="buckarooKlarnakpPhone">
                        {{ "buckaroo.checkout.buckarooKlarnakpPhone"|trans|sw_sanitize }}{{ "general.required"|trans|sw_sanitize }}
                    </label>

                    <input type="text"
                           class="form-control{% if formViolations.getViolations('/title') %} is-invalid{% endif %}"
                           form="confirmOrderForm"
                           id="buckarooKlarnakpPhone"
                           name="buckaroo_klarnakp_phone"
                           placeholder="{{ "buckaroo.checkout.buckarooKlarnakpPhonePlaceholder"|trans|striptags }}{{ "general.required"|trans|striptags }}"
                           value=""
                           required="required"
                           minlength="10">
                </div>

                <div class="form-group">
                    <label class="label" for="buckaroo_klarnakp_DoB">{{ "buckaroo.checkout.buckarooKlarnakpDoBTitle"|trans }}:</label>
                    <span><sup>{{ "buckaroo.checkout.buckarooKlarnakpDoBTitleSup"|trans }}</sup></span>
                    <div class="control">
                        <input id="buckaroo_klarnakp_DoB"
                               class="form-control field"
                               type="date"
                               name="buckaroo_klarnakp_DoB"
                               form="confirmOrderForm"
                               required="required"
                        >
                    </div>
                </div>

            </fieldset>
        </div>

    {% else %}
        <strong>{{ "checkout.confirmCurrentPaymentShipping"|trans|sw_sanitize }}</strong>
        {{ page.extensions.buckaroo.payment_labels[context.paymentMethod.translated.customFields.buckaroo_key]?:context.paymentMethod.translated.name }}
    {% endif %}
    
{% endblock %}

{% block page_checkout_confirm_payment_inner %}
    {{ parent() }}
    {% if context.paymentMethod.formattedHandlerIdentifier == 'handler_buckaroo_applepaypaymenthandler' %}
        <div id="applepay-button-container" class="applepay-button-container" style="display:none;">
            <div></div>
        </div>
        <input type="hidden"
               form="confirmOrderForm"
               id="applePayInfo"
               name="applePayInfo"
               value="">
        <script>
            if (!window.buckaroo) {
                window.buckaroo = {
                    submit: false,
                    csrf: {
                        '/Buckaroo/applepayInit': '{{ sw_csrf("frontend.buckaroo.applepayInit", {"mode": "token"}) }}',
                        '/Buckaroo/applepaySaveOrder': '{{ sw_csrf("frontend.buckaroo.applepaySaveOrder", {"mode": "token"}) }}'
                    }
                };
            }
            setTimeout(function() {
                if (document.getElementById('confirmFormSubmit')) {
                    document.getElementById('confirmFormSubmit').disabled = true;
                    document.getElementById('confirmFormSubmit').addEventListener('click', function(e){
                        e.stopPropagation();
                    });
                    document.getElementById('confirmOrderForm').addEventListener('submit', function(e){
                        if (window.buckaroo.submit) {
                            //allow to submit
                            return true;
                        } else {
                            //don't allow to submit
                            e.preventDefault();
                            var child = document.querySelector('.apple-pay-button');
                            if (child) {
                                //ZAK
                                console.log("====applepay====order submit3");
                                child.click();
                            }
                        }
                    });
                }
            }, 200)
        </script>
        <script type="module" src="/bundles/buckaroopayment/storefront/buckaroo/js/applepay/index.js"></script>
    {% endif %}
{% endblock %}
